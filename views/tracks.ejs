<div class="card">
  <h3>Play Tracks</h3>
 <form class="form-inline" method="post" action="/admin/tracks" enctype="multipart/form-data">
  <select name="category_id" required>
    <option value="">Select category</option>
    <% categories.forEach(cat => { %>
      <option value="<%= cat.id %>"><%= cat.name %></option>
    <% }) %>
  </select>
  <input type="text" name="title" placeholder="Track title" required>
  <input type="text" name="description" placeholder="Description (optional)">
  <input type="number" step="0.01" name="price_inr" placeholder="Price (INR)" required>
  <select name="status">
    <option value="active">active</option>
    <option value="inactive">inactive</option>
  </select>
  <!-- NEW: MP3 upload -->
 <input type="file" name="thumb" accept=".png,.jpg,.jpeg,.webp">
  <input type="file" name="mp3" accept=".mp3,audio/mpeg">

  <button type="submit">Add Track</button>
</form>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Title</th><th>Category</th><th>Price (â‚¹)</th><th>Status</th><th>Created</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% tracks.forEach(t => { %>
          <tr>
            <td><%= t.id %></td>
            <td colspan="4">
             <form class="row" method="post" action="/admin/tracks/<%= t.id %>" enctype="multipart/form-data">
  <input type="text" name="title" value="<%= t.title %>" required>
  <select name="category_id" required>
    <% categories.forEach(cat => { %>
      <option value="<%= cat.id %>" <%= cat.id===t.category_id ? 'selected' : '' %>><%= cat.name %></option>
    <% }) %>
  </select>
  <input type="text" name="description" value="<%= t.description || '' %>" placeholder="Description">
  <input type="number" step="0.01" name="price_inr" value="<%= (t.price_paise/100).toFixed(2) %>" required>
  <select name="status">
    <option value="active" <%= t.status==='active' ? 'selected' : '' %>>active</option>
    <option value="inactive" <%= t.status==='inactive' ? 'selected' : '' %>>inactive</option>
  </select>

  <!-- NEW: Replace MP3 -->
 <input type="file" name="thumb" accept=".png,.jpg,.jpeg,.webp">
  <% if (t.thumbnail_path) { %>
    <img src="<%= t.thumbnail_path %>" alt="" style="height:40px;border-radius:8px;">
  <% } %>

  <input type="file" name="mp3" accept=".mp3,audio/mpeg">
  <% if (t.mp3_path) { %>
    <audio controls style="max-width:240px; display:block;">
      <source src="<%= t.mp3_path %>" type="audio/mpeg">
    </audio>
  <% } %>

  <button type="submit">Save</button>
</form>

            </td>
            <td><%= new Date(t.created_at).toLocaleString() %></td>
            <td>
              <form method="post" action="/admin/tracks/<%= t.id %>/delete" onsubmit="return confirm('Delete this track?')">
                <button type="submit" class="danger">Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <%- include('partials/pagination', { pagination, base: '/admin/tracks', extra: {} }) %>
</div>


<script>
document.addEventListener('change', function(e){
  if (e.target.name === 'mp3') {
    const file = e.target.files[0];
    if (!file) return;
    const audio = document.createElement('audio');
    audio.preload = 'metadata';
    audio.onloadedmetadata = () => {
      const secs = Math.round(audio.duration || 0);
      let hidden = e.target.form.querySelector('input[name="duration_sec"]');
      if (!hidden) {
        hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'duration_sec';
        e.target.form.appendChild(hidden);
      }
      hidden.value = secs;
      URL.revokeObjectURL(audio.src);
    };
    audio.src = URL.createObjectURL(file);
  }
});
</script>